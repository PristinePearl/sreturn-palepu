<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Return Viewer - Palepu (SS)</title>
 <link rel="icon" 
        href="https://media.licdn.com/dms/image/v2/D5603AQHMvZTgZ4pbzA/profile-displayphoto-shrink_200_200/profile-displayphoto-shrink_200_200/0/1682685098699?e=2147483647&v=beta&t=87_-l2z-dvgwfndQGnhEdmTpcvEr5Updl0nb71DfHHs" 
        type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8fafc;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            height: 100vh;
        }

        .left-panel {
            width: 350px;
            background: white;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }

        .right-panel {
            flex: 1;
            background: #fafbfc;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .header {
            /* CHANGED: From Deep Red/Maroon Gradient to Deep Indigo Gradient */
            background: linear-gradient(135deg, #800000 0%, #dc2626 100%); 
            color: white;
            padding: 15px 20px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .company-logo {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
            letter-spacing: -0.01em;
        }

        .header .subtitle {
            font-size: 0.8rem;
            opacity: 0.8;
            font-weight: 400;
            margin-left: 8px;
        }

        /* --- Tabs Styling --- */
        .tabs {
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        .tab-button {
            padding: 12px 20px;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }
        
        /* Highlight active tab */
        .tab-button.active {
            background: #f1f5f9;
            font-weight: 600;
            /* CHANGED: From Dark Maroon to Dark Indigo */
            color: #800000; 
            /* CHANGED: From Red to Indigo */
            border-left: 4px solid #dc2626; 
        }

        .tab-button:hover:not(.active) {
            background: #f9fafb;
            /* CHANGED: From Dark Maroon to Dark Indigo */
            color: #800000; 
        }

        .search-section {
            padding: 20px;
            background: #f8fafc;
            flex: 1;
            /* Only this section needs to scroll */
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
        }
        
        /* Hide all report content by default */
        .tab-content {
            display: none;
        }
        /* Display the content of the active tab */
        .tab-content.active {
            display: block;
        }
        
        /* --- Forms & Inputs --- */
        .search-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 0; 
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.85rem;
            letter-spacing: 0.025em;
        }

        .form-group input, .form-group select {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: white;
        }
        
        /* Adjust for radio buttons */
        .form-group input[type="radio"] {
             width: auto;
             height: auto;
             padding: 0;
             margin: 0 5px 0 0;
             border: none;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            /* CHANGED: From Red to Indigo */
            border-color: #dc2626; 
            /* CHANGED: From Red Shadow to Indigo Shadow */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); 
        }

        .form-group input::placeholder {
            color: #9ca3af;
            font-style: italic;
        }

        .btn {
            padding: 12px 20px;
            /* CHANGED: From Red Gradient to Indigo Gradient */
            background: linear-gradient(135deg, #dc2626 0%, #800000 100%); 
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        .btn:hover {
            /* CHANGED: From Darker Red Gradient to Darker Indigo Gradient */
            background: linear-gradient(135deg, #800000 0%, #990e0e 100%); 
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* NEW BUTTON STYLE FOR EXPORT */
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #374151 100%);
            margin-top: 5px; 
        }
        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563 0%, #1f2937 100%);
        }

        .results-section {
            padding: 10px;
            flex: 1;
            background: white;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            color: #64748b;
            font-style: italic;
            padding: 40px;
            font-size: 1rem;
        }

        .error {
            background: #fef2f2; /* CHANGED: From Red to Light Blue */
            color: #dc2626; /* CHANGED: From Red to Indigo */
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dc2626; /* CHANGED: From Red to Indigo */
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .result-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #e5e7eb;
        }
        .result-card .result-header h2 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .sr-ref {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
        }

        .total-amount {
            /* Kept Green for positive financial sign */
            font-size: 1rem;
            font-weight: 700;
            color: #059669; 
            background: #ecfdf5;
            padding: 3px 6px;
            border-radius: 3px;
            border: 1px solid #a7f3d0;
        }

        .document-sections {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .section-header {
            background: #1f2937;
            color: white;
            padding: 6px 10px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .section-content {
            padding: 8px;
        }

        .section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 6px;
        }

        .field {
            display: flex;
            flex-direction: column;
            background: white;
            padding: 6px;
            border-radius: 3px;
            border: 1px solid #e5e7eb;
        }

        .field-label {
            font-size: 0.7rem;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 2px;
            letter-spacing: 0.05em;
        }

        .field-value {
            font-size: 0.85rem;
            color: #1f2937;
            font-weight: 500;
            word-break: break-word;
        }

        .no-results {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 20px 10px;
            font-size: 0.9rem;
            background: #f9fafb;
            border-radius: 4px;
            border: 1px dashed #d1d5db;
        }

        /* --- Styles for the Product Table --- */
        .product-table-container {
            overflow-x: auto;
            margin-top: 0;
            border: 0;
        }
        .product-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            min-width: 900px; 
        }
        .product-table th, .product-table td {
            border: 1px solid #e5e7eb;
            padding: 8px 10px;
            text-align: left;
        }
        .product-table th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #1f2937;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .product-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .product-table .total-row td {
            /* Kept Green for consistency with total-amount */
            font-weight: 700;
            background-color: #ecfdf5;
            color: #059669;
        }
        /* Chart specific styles */
        .chart-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
            justify-content: center;
            align-items: flex-start;
        }
        .chart-box {
            background: white;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            max-width: 45%; /* Limits size on large screens */
            min-width: 300px;
            flex-grow: 1;
        }
        .chart-box h3 {
            font-size: 1rem;
            /* CHANGED: From Dark Maroon to Dark Indigo */
            color: #800000;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e2e8f0;
        }


        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .left-panel {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
                overflow-y: visible;
            }
            
            .right-panel {
                height: 60vh;
            }
            
            .header h1 {
                font-size: 1.1rem;
            }
            
            .search-section {
                padding: 15px;
            }
            
            .section-grid {
                grid-template-columns: 1fr;
                gap: 4px;
            }
            
            .result-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .product-table {
                min-width: 600px; 
            }
            .chart-box {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
<div class="left-panel">
    <div class="header">
        <div class="header-content">
            <img src="https://media.licdn.com/dms/image/v2/D5603AQHMvZTgZ4pbzA/profile-displayphoto-shrink_200_200/profile-displayphoto-shrink_200_200/0/1682685098699?e=2147483647&v=beta&t=87_-l2z-dvgwfndQGnhEdmTpcvEr5Updl0nb71DfHHs" alt="PALEPU Logo" class="company-logo">
            <h1>PALEPU PHARMA DISTRIBUTORS (SS)</h1>
        </div>
    </div>
            
    <div class="tabs">
        <button class="tab-button active" onclick="openTab(event, 'srSearch')">üîç Single SR Search</button>
        <button class="tab-button" onclick="openTab(event, 'dateStockist')">üìú Stockist/Date Report</button>
        <button class="tab-button" onclick="openTab(event, 'productAnalysis')">üì¶ Product Analysis</button>
        <button class="tab-button" onclick="openTab(event, 'expiryQuality')">‚ö†Ô∏è Expiry/Quality Report</button>
        <button class="tab-button" onclick="openTab(event, 'graphicalReports')">üìä Graphical Reports</button>
        <button class="tab-button" onclick="openTab(event, 'aiAnalysis')">üìà AI & Trend Analysis</button>

    </div>

    <div class="search-section">

        <div id="srSearch" class="tab-content active">
            <form class="search-form" id="searchForm">
                <h3 style="font-size: 1rem; margin-bottom: 5px; color: #800000;">Individual SR Search</h3>
                <div class="form-group" style="display: none;">
                    <label for="sheetId">Google Sheet ID:</label>
                    <input type="text" id="sheetId" placeholder="Enter Google Sheet ID" value="1WI_6zey1A9Il13yajAstX6CyOG__RWGJ246PVMRFnHc" required>
                </div>
                <div class="form-group">
                    <label for="srRefNo">SR Ref No / C. Inv No:</label>
                    <input type="text" id="srRefNo" placeholder="Enter SR Reference or Customer Inv No" required oninput="this.value = this.value.toUpperCase()">
                </div>
                <button type="submit" class="btn">Search</button>
                <button type="button" class="btn btn-secondary" id="exportBtn" style="display: none;">EXPORT (Single SR)</button>
            </form>
        </div>


        <div id="dateStockist" class="tab-content">
            <form class="search-form" id="dateStockistForm">
                 <h3 style="font-size: 1rem; margin-bottom: 5px; color: #800000;">Date / Stockist Report (Dates Optional)</h3>
                <div class="form-group">
                    <label for="fromDate">From Date (C. INV DATE):</label>
                    <input type="date" id="fromDate">
                </div>
                <div class="form-group">
                    <label for="toDate">To Date (C. INV DATE):</label>
                    <input type="date" id="toDate">
                </div>
                <div class="form-group">
                    <label for="stockistSelect">Stockist Name:</label>
                    <select id="stockistSelect">
                        <option value="">All Stockists</option>
                    </select>
                </div>
                <button type="submit" class="btn">Go</button>
                <button type="button" class="btn btn-secondary" id="exportAllBtn" style="display: none;">EXPORT ALL</button>
            </form>
        </div>


        <div id="productAnalysis" class="tab-content">
            <form class="search-form" id="productForm">
                <h3 style="font-size: 1rem; margin-bottom: 5px; color: #800000;">Product Analysis Report</h3>
                <div class="form-group">
                    <label for="productSelect">Product Name:</label>
                    <select id="productSelect" required>
                        <option value="">Select Product</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="batchInput">Batch No (Optional):</label>
                    <input type="text" id="batchInput" placeholder="Enter Batch No">
                </div>
                <button type="submit" class="btn">Generate Product Report</button>
                <button type="button" class="btn btn-secondary" id="exportProductBtn" style="display: none;">EXPORT REPORT</button>
            </form>
        </div>


        <div id="expiryQuality" class="tab-content">
            <form class="search-form" id="expiryForm">
                <h3 style="font-size: 1rem; margin-bottom: 5px; color: #800000;">Expiry/Quality Report</h3>
                <div class="form-group">
                    <label for="expiryBeforeDate">Expiry Date (Before):</label>
                    <input type="date" id="expiryBeforeDate" required>
                </div>
                <div class="form-group">
                    <label for="remarksKeyword">Remarks Keyword (e.g., DAMAGE):</label>
                    <input type="text" id="remarksKeyword" placeholder="Optional Keyword">
                </div>
                <div class="form-group">
                    <label for="expiryStockistSelect">Stockist Name (Optional):</label>
                    <select id="expiryStockistSelect">
                        <option value="">All Stockists</option>
                    </select>
                </div>
                <button type="submit" class="btn">Generate Expiry Report</button>
                <button type="button" class="btn btn-secondary" id="exportExpiryBtn" style="display: none;">EXPORT REPORT</button>
            </form>
        </div>


        <div id="graphicalReports" class="tab-content">
            <form class="search-form" id="chartReportForm">
                <h3 style="font-size: 1rem; margin-bottom: 5px; color: #800000;">Product & Stockist Graphical Report (Dates Optional)</h3>
                 <div class="form-group">
                    <label for="chartFromDate">From Date (C. INV DATE):</label>
                    <input type="date" id="chartFromDate">
                </div>
                <div class="form-group">
                    <label for="chartToDate">To Date (C. INV DATE):</label>
                    <input type="date" id="chartToDate">
                </div>
                <div class="form-group">
                    <label for="chartProductSelect">Product Name (Optional):</label>
                    <select id="chartProductSelect">
                        <option value="">All Products</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="chartStockistSelect">Stockist Name (Optional):</label>
                    <select id="chartStockistSelect">
                        <option value="">All Stockists</option>
                    </select>
                </div>
                <button type="submit" class="btn">Generate Charts</button>
                <button type="button" class="btn btn-secondary" id="exportChartBtn" style="display: none;">EXPORT RAW DATA</button>
            </form>
        </div>

        <div id="aiAnalysis" class="tab-content">
            <form class="search-form" id="aiAnalysisForm">
                <h3 style="font-size: 1rem; margin-bottom: 5px; color: #800000;">AI & Trend Analysis Report (Dates Optional)</h3>
                 <div class="form-group">
                    <label for="aiFromDate">From Date (C. INV DATE):</label>
                    <input type="date" id="aiFromDate">
                </div>
                <div class="form-group">
                    <label for="aiToDate">To Date (C. INV DATE):</label>
                    <input type="date" id="aiToDate">
                </div>
                <div class="form-group">
                    <label>Monthly Trend Chart Type:</label>
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <input type="radio" id="chartTypeBar" name="trendChartType" value="bar" checked>
                        <label for="chartTypeBar" style="font-weight: normal; margin-top: 0; font-size: 0.9rem; margin-left: -12px;">Bar</label>
                        <input type="radio" id="chartTypeLine" name="trendChartType" value="line">
                        <label for="chartTypeLine" style="font-weight: normal; margin-top: 0; font-size: 0.9rem; margin-left: -12px;">Line</label>
                    </div>
                </div>
                <button type="submit" class="btn">Generate AI Report</button>
            </form>
        </div>
<div id="printDoc" class="tab-content">
<form class="search-form" id="printForm">

<h3 style="font-size:1rem;color:#800000;">Print Document</h3>

<div class="form-group">
<label>From Date (C. INV DATE)</label>
<input type="date" id="printFrom">
</div>

<div class="form-group">
<label>To Date (C. INV DATE)</label>
<input type="date" id="printTo">
</div>

<div class="form-group">
<label>Stockist Name</label>
<select id="printStockist">
<option value="">All Stockists</option>
</select>
</div>

<div class="form-group">
<label>Search SR Ref / C.Inv No</label>
<input type="text" id="printSearch" placeholder="Optional">
</div>

<button type="submit" class="btn">Generate Report</button>
<button type="button" class="btn btn-secondary" id="printPdfBtn" style="display:none;">Download PDF</button>

</form>
</div>
    </div>
</div>

        <div class="right-panel">
            <div class="results-section" id="resultsSection">
                <div class="no-results">Enter SR Reference Number or C. Inv No and click Search to view results</div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for storing results for export functions
        let lastSearchResults = []; // For single SR search
        let lastFilterResults = []; // For all tabular/graphical report exports
        window.groupedResults = {}; // To store the grouped data for in-card export
        
        let barChartInstance = null; // Used for Bar Chart and Monthly Trend Chart (Line/Bar Chart)
        let pieChartInstance = null;

        // --- Core Tab Navigation Function (NEW) ---
        function openTab(evt, tabName) {
            // Declare all variables
            let i, tabcontent, tablinks;

            // Get all elements with class="tab-content" and hide them
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove('active');
            }

            // Get all elements with class="tab-button" and remove the "active" class
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }

            // Show the current tab, and add an "active" class to the button that opened the tab
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add("active");

            // Clear results section when switching reports (optional, but good practice)
            document.getElementById('resultsSection').innerHTML = '<div class="no-results">Run the report using the controls above.</div>';
            hideAllExportButtons();
            destroyCharts();
        }

        // --- Core Data Fetching Functions ---

        async function fetchSheetData(sheetId) {
            const methods = [
                // Primary method for public sheets
                `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`,
                // Fallbacks
                `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`,
                `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`,
                `https://cors-anywhere.herokuapp.com/https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`,
                `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`)}`
            ];

            let lastError = null;
            
            for (const url of methods) {
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'Accept': 'text/csv,text/plain,*/*'
                        }
                    });
                    
                    if (response.ok) {
                        const csvText = await response.text();
                        return parseCSV(csvText);
                    }
                } catch (error) {
                    lastError = error;
                }
            }
            
            throw new Error('Failed to fetch data from Google Sheets. Please check the Sheet ID and ensure the sheet is publicly accessible.');
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                data.push(row);
            }
            
            return data;
        }

        // Utility function to parse DD/MM/YYYY to a Date object
        function parseDate(dateString) {
            if (!dateString) return null;
            const parts = dateString.split('/');
            if (parts.length === 3) {
                // new Date(year, monthIndex, day) - Month is 0-indexed
                const date = new Date(parts[2], parts[1] - 1, parts[0]);
                date.setHours(12, 0, 0, 0); // Normalize time
                return date;
            }
            return null;
        }


        // --- Export Functions ---

        // Function to export the results array to CSV/Excel
        function exportToCSV(data, filename) {
            if (!data || data.length === 0) {
                alert("No data to export.");
                return;
            }

            const headers = Object.keys(data[0]);
            const csvRows = [];
            
            // Add header row
            csvRows.push(headers.map(h => `"${h}"`).join(','));

            // Add data rows
            for (const row of data) {
                const values = headers.map(header => {
                    let value = row[header] === undefined || row[header] === null ? '' : String(row[header]);
                    
                    // Format EXPIRY to MM/YY
                    if (header === 'EXPIRY') {
                        const match = value.match(/(\d{1,2})\/(\d{4})/);
                        if (match) {
                             const month = match[1].padStart(2, '0'); 
                             const year = match[2].slice(-2);
                             value = `${month}/${year}`;
                        }
                    }

                    // Escape double quotes and wrap in quotes
                    return `"${value.replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            }

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");

            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `${filename}.csv`); 
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                window.open('data:text/csv;charset=utf-8,' + encodeURIComponent(csvString));
            }
        }

        // Function to export a single expanded card's data (used by the Export This SR button)
        function exportExpandedCardData(srRef) {
            if (window.groupedResults && window.groupedResults[srRef]) {
                const data = window.groupedResults[srRef];
                const stockistName = data[0]['STOCKIST NAME'].replace(/[^a-zA-Z0-9 ]/g, "").trim(); 
                const filename = `${stockistName} - ${srRef.replace(/[^a-zA-Z0-9 ]/g, "").trim()}`;
                exportToCSV(data, filename);
            } else {
                alert("Error: Data for this SR reference not found for export.");
            }
        }
        
        // --- UI Rendering Functions ---

        function generateResultCardHtml(results, isExpandedView = false) {
            
            const firstResult = results[0];
            
            // Calculate totals
            const totalGrandAmount = results.reduce((sum, row) => sum + (parseFloat(row['TOTAL'].replace(/[^0-9.-]+/g,"")) || 0), 0).toFixed(2);
            const totalTaxable = results.reduce((sum, row) => sum + (parseFloat(row['TAXABLE'].replace(/[^0-9.-]+/g,"")) || 0), 0).toFixed(2);
            const totalGST = results.reduce((sum, row) => sum + (parseFloat(row['GST VALUE'].replace(/[^0-9.-]+/g,"")) || 0), 0).toFixed(2);

            
            // Set export function call for the in-card button
            const exportFunction = isExpandedView ? `exportExpandedCardData('${firstResult['SR Ref No.']}')` : `document.getElementById('exportBtn').click()`;


            // Generate product table rows
            const productRows = results.map((result, index) => {
                const lineTotal = (parseFloat(result['TOTAL'].replace(/[^0-9.-]+/g,"")) || 0).toFixed(2);
                const unitRate = (parseFloat(result['RATE'].replace(/[^0-9.-]+/g,"")) || 0).toFixed(2);
                const taxableAmt = (parseFloat(result['TAXABLE'].replace(/[^0-9.-]+/g,"")) || 0).toFixed(2);
                const gstValue = (parseFloat(result['GST VALUE'].replace(/[^0-9.-]+/g,"")) || 0).toFixed(2);
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${result['PRODUCT']}</td>
                        <td>${result['BATCH']}</td>
                        <td>${result['EXPIRY']}</td>
                        <td>${result['QTY']}</td>
<td>${result['FQTY'] || '-'}</td>
                        <td style="text-align: right;">‚Çπ${unitRate}</td>
                        <td style="text-align: right;">‚Çπ${taxableAmt}</td>
                        <td style="text-align: right;">‚Çπ${gstValue}</td>
                        <td style="text-align: right;">‚Çπ${lineTotal}</td>
<td>${result['STATUS'] || '-'}</td>
                        <td>${result['REMARKS'] || '-'}</td>
                    </tr>
                `;
            }).join('');

            const html = `
                <div class="result-card">
                    <div class="result-header" style="flex-wrap: wrap;">
                        <h2> PALEPU PHARMA DISTRIBUTORS (SS) </h2>
                        <div class="sr-ref">Sales Return: ${firstResult['SR Ref No.']}</div>
                        <div class="total-amount">Grand Total: ‚Çπ${totalGrandAmount}</div> 
                        ${isExpandedView ? `
<div style="display:flex;gap:8px">

<button type="button"
class="btn btn-secondary"
onclick="${exportFunction}"
style="margin-top:0;padding:6px 12px;font-size:0.8rem">
Export This SR
</button>

<button type="button"
class="btn btn-secondary"
onclick="downloadSR('${firstResult['SR Ref No.']}')"
style="margin-top:0;padding:6px 12px;font-size:0.8rem">
Download
</button>

</div>
` : ''}

                    </div>
                    
                    <div class="document-sections">
                        <div class="section">
                            <div class="section-header">Return Information</div>
                            <div class="section-content">
                                <div class="section-grid">
                                    <div class="field">
                                        <div class="field-label">Uploaded Date</div>
                                        <div class="field-value">${firstResult['R.GEN DATE']}</div>
                                    </div>
                                    <div class="field">
                                        <div class="field-label">Customer Invoice Date</div>
                                        <div class="field-value">${firstResult['C. INV DATE']}</div>
                                    </div>
                                    <div class="field">
                                        <div class="field-label">Customer Invoice No</div>
                                        <div class="field-value">${firstResult['C. INV NO.']}</div>
                                    </div>
                                    <div class="field">
                                        <div class="field-label">Credit Note No</div>
                                        <div class="field-value">${firstResult['CN NO.'] || '-'}</div>
                                    </div>
                                    <div class="field">
                                        <div class="field-label">Credit Note Date</div>
                                        <div class="field-value">${firstResult['CN DATE'] || '-'}</div>
                                    </div>
<div class="field">
    <div class="field-label">Courier Name</div>
    <div class="field-value">${firstResult['COURIER NAME'] || '-'}</div>
</div>

<div class="field">
    <div class="field-label">POD No</div>
    <div class="field-value">${firstResult['POD NO.'] || '-'}</div>
</div>
                                </div>
                            </div>
                        </div>

                        <div class="section">
                            <div class="section-header">Stockist Details</div>
                            <div class="section-content">
                                <div class="section-grid">
                                    <div class="field">
                                        <div class="field-label">Stockist Code</div>
                                        <div class="field-value">${firstResult['STOCKIST CODE']}</div>
                                    </div>
                                    <div class="field">
                                        <div class="field-label">Stockist Name</div>
                                        <div class="field-value">${firstResult['STOCKIST NAME']}</div>
                                    </div>
                                    <div class="field">
                                        <div class="field-label">Area</div>
                                        <div class="field-value">${firstResult['AREA']}</div>
                                    </div>
                                    <div class="field">
                                        <div class="field-label">State</div>
                                        <div class="field-value">${firstResult['STATE']}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="section">
                            <div class="section-header">PRODUCT DETAILS (${results.length} Products)</div>
                            <div class="product-table-container">
                                <table class="product-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Product Name</th>
                                            <th>Batch No</th>
                                            <th>Expiry Date</th>
                                            <th>Qty</th>
<th>FQty</th>
                                            <th style="text-align: right;">Unit Rate</th>
                                            <th style="text-align: right;">Taxable Amt</th>
                                            <th style="text-align: right;">GST Value</th>
                                            <th style="text-align: right;">Total Value</th>
<th>Status</th>
                                            <th>Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${productRows}
                                        <tr class="total-row">
<td colspan="7" style="text-align: right; font-weight: 700;">TOTALS:</td>
<td style="text-align: right;">‚Çπ${totalTaxable}</td>
<td style="text-align: right;">‚Çπ${totalGST}</td>
<td style="text-align: right;">‚Çπ${totalGrandAmount}</td>
<td></td>
<td></td>
</tr>

                                    </tbody>
                                </table>
                            </div>
                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

function generateInvoiceHTML(rows){

const r = rows[0];

let totalTaxable=0;
let totalGST=0;
let grandTotal=0;

const tableRows = rows.map((row,i)=>{

const rate=parseFloat(row['RATE'])||0;
const taxable=parseFloat(row['TAXABLE'])||0;
const gst=parseFloat(row['GST VALUE'])||0;
const total=parseFloat(row['TOTAL'])||0;

totalTaxable+=taxable;
totalGST+=gst;
grandTotal+=total;

return `
<tr>
<td>${i+1}</td>
<td>${row['PRODUCT']}</td>
<td>${row['BATCH']}</td>
<td>${row['EXPIRY']}</td>
<td>${row['QTY']}</td>
<td>${row['FQTY']||''}</td>
<td>${rate.toFixed(2)}</td>
<td>${taxable.toFixed(2)}</td>
<td>${gst.toFixed(2)}</td>
<td>${total.toFixed(2)}</td>
<td>${row['STATUS']||''}</td>
<td>${row['REMARKS']||''}</td>
</tr>`;
}).join("");

return `
<div class="print-area">

<!-- HEADER -->
<div class="invoice-header">
<img src="https://media.licdn.com/dms/image/v2/D5603AQHMvZTgZ4pbzA/profile-displayphoto-shrink_200_200/profile-displayphoto-shrink_200_200/0/1682685098699?e=2147483647&v=beta&t=87_-l2z-dvgwfndQGnhEdmTpcvEr5Updl0nb71DfHHs" class="logo">

<div class="company">
<div class="title">PALEPU PHARMA DISTRIBUTORS (SS)</div>
<div class="subtitle">CUSTOMER SALES RETURN DETAILS</div>
</div>

<div style="font-size:14px;font-weight:600;color:#800000">
REF: ${r['SR Ref No.']}
</div>
</div>


<!-- INFO TABLE -->
<table class="info-table">
<tr>
<td><b>CUSTOMER</b> : ${r['STOCKIST NAME']}</td>
<td><b>CODE</b> : ${r['STOCKIST CODE']}</td>
<td><b>AREA</b> : ${r['AREA']} - ${r['STATE']}</td>
</tr>

<tr>
<td><b>UPLOADED ON</b> : ${r['R.GEN DATE']}</td>
<td><b>C. INV NO.</b> : ${r['C. INV NO.']}</td>
<td><b>C. INV DATE</b> : ${r['C. INV DATE']}</td>
</tr>

<tr>
<td><b>OUR CN NO.</b> : ${r['CN NO.']||''}</td>
<td><b>OUR CN Date</b> : ${r['CN DATE']||''}</td>
<td><b>COURIER</b> : ${r['COURIER NAME']||''}</td>
</tr>

<tr>
<td colspan="3"><b>POD NO.</b> : ${r['POD NO.']||''}</td>
</tr>
</table>


<!-- PRODUCT TABLE -->
<table class="product-table">
<thead>
<tr>
<th>#</th>
<th>PRODUCT</th>
<th>BATCH</th>
<th>EXPIRY</th>
<th>QTY</th>
<th>F QTY</th>
<th>RATE</th>
<th>TAXABLE</th>
<th>GST</th>
<th>TOTAL</th>
<th>STATUS</th>
<th>REMARKS</th>
</tr>
</thead>

<tbody>
${tableRows}

<tr class="total-row">
<td colspan="7">TOTALS</td>
<td>${totalTaxable.toFixed(2)}</td>
<td>${totalGST.toFixed(2)}</td>
<td>${grandTotal.toFixed(2)}</td>
<td></td>
<td></td>
</tr>

</tbody>
</table>


<!-- FOOTER -->
<div class="footer">
This is a system generated document
</div>

</div>


<style>

.print-area{
width:1000px;
margin:auto;
font-family:Segoe UI,Arial;
color:#000;
}

/* HEADER */
.invoice-header{
display:flex;
align-items:center;
justify-content:space-between;
border-bottom:3px solid #dc2626;
padding-bottom:10px;
margin-bottom:12px;
}

.logo{
height:60px;
}

.company{
text-align:center;
flex:1;
}

.title{
font-size:22px;
font-weight:700;
color:#800000;
}

.subtitle{
font-size:13px;
color:#555;
}


/* INFO TABLE */
.info-table{
width:100%;
border-collapse:collapse;
margin-bottom:12px;
}

.info-table td{
border:1px solid #000;
padding:7px;
font-size:13px;
}


/* PRODUCT TABLE */
.product-table{
width:100%;
border-collapse:collapse;
font-size:12px;
}

.product-table th{
background:#dc2626;
color:white;
border:1px solid #000;
padding:7px;
}

.product-table td{
border:1px solid #000;
padding:6px;
text-align:center;
}

.total-row td{
font-weight:bold;
background:#fef2f2;
font-size:15px;
padding:10px;
}

.total-row td:nth-child(10){
font-size:18px;
font-weight:900;
color:#800000;
}

/* FOOTER */
.footer{
margin-top:12px;
font-size:11px;
text-align:center;
color:#555;
border-top:1px dashed #aaa;
padding-top:6px;
}

/* PRINT SETTINGS */
@media print{
body *{visibility:hidden}
.print-area,.print-area *{visibility:visible}
.print-area{
position:absolute;
left:0;
top:0;
width:100%;
}
}

</style>
`;
}

        // Wrapper function to display results in the main area (used by single SR search)
        function displayResults(results) {
            const resultsSection = document.getElementById('resultsSection');
            // Pass true for isExpandedView since this is the main single-SR view
            resultsSection.innerHTML = generateResultCardHtml(results, true);
        }

        // Function to display simple tabular results for the other reports
        function displaySummaryTable(data, headers, title, exportBtnId) {
            const resultsSection = document.getElementById('resultsSection');
            const exportBtn = document.getElementById(exportBtnId);
            
            // Hide all other export buttons
            hideAllExportButtons();
            
            if (data.length === 0) {
                resultsSection.innerHTML = `<div class="no-results">No records found for the ${title} report.</div>`;
                return;
            }

            // Set lastFilterResults for the Export button to use and display the button
            lastFilterResults = data;
            exportBtn.style.display = 'block';

            let tableHtml = `
                <h2 style="font-size: 1.2rem; color: #800000; padding: 10px 0; border-bottom: 2px solid #e5e7eb; margin-bottom: 15px;">${title} (${data.length} Records)</h2>
                <div class="product-table-container">
                    <table class="product-table" style="min-width: 100%;">
                        <thead>
                            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
            `;

            // Map data fields to table columns based on headers
            data.forEach(row => {
                tableHtml += '<tr>';
                headers.forEach(header => {
                    // Check for header key in row object (using row[header] or row['header'] logic)
                    let value = row[header] || '-'; 

                    // Special formatting for value columns
                    if (header.includes('Value') || header.includes('Total') || header === 'TAXABLE' || header === 'GST VALUE') {
                        // Use raw number for internal comparison, but format for display
                        const numericValue = parseFloat(row[header].replace(/[^0-9.-]+/g,"")) || 0;
                        value = `‚Çπ${numericValue.toFixed(2)}`;
                        tableHtml += `<td style="text-align: right;">${value}</td>`;
                    } else if (header === 'Quantity' || header === 'QTY') {
                        tableHtml += `<td style="text-align: center;">${value}</td>`;
                    } 
                    else {
                        tableHtml += `<td>${value}</td>`;
                    }
                });
                tableHtml += '</tr>';
            });

            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;

            resultsSection.innerHTML = tableHtml;
        }

        // Function to destroy and reset chart canvas
        function destroyCharts() {
            if (barChartInstance) {
                barChartInstance.destroy();
                barChartInstance = null;
            }
            if (pieChartInstance) {
                pieChartInstance.destroy();
                pieChartInstance = null;
            }
        }
    

        // --- Event Handlers ---

        // Helper function to hide all report export buttons
        function hideAllExportButtons() {
            document.getElementById('exportBtn').style.display = 'none';
            document.getElementById('exportAllBtn').style.display = 'none';
            document.getElementById('exportProductBtn').style.display = 'none';
            document.getElementById('exportExpiryBtn').style.display = 'none';
            document.getElementById('exportChartBtn').style.display = 'none';
document.getElementById('printPdfBtn').style.display='none';
        }
        
        // Handle Search by SR Ref No
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const sheetId = document.getElementById('sheetId').value.trim();
            const searchTerm = document.getElementById('srRefNo').value.trim().toUpperCase(); 
            const resultsSection = document.getElementById('resultsSection');
            
            hideAllExportButtons();
            destroyCharts();

            if (!sheetId || !searchTerm) {
                resultsSection.innerHTML = '<div class="error">Please enter Google Sheet ID and SR Reference/Invoice Number</div>';
                return;
            }
            
            resultsSection.innerHTML = '<div class="loading">Searching for sales return data...</div>';
            
            try {
                const data = await fetchSheetData(sheetId);
                
                const results = data.filter(row => 
                    (row['SR Ref No.'] && row['SR Ref No.'].toUpperCase() === searchTerm) ||
                    (row['C. INV NO.'] && row['C. INV NO.'].toUpperCase() === searchTerm)
                );
                
                if (results && results.length > 0) {

    lastSearchResults = results;

    // ‚≠ê ADD THIS LINE
    window.groupedResults = {
        [results[0]['SR Ref No.']]: results
    };

    displayResults(results);

    document.getElementById('exportBtn').style.display = 'block';
} else {
                    resultsSection.innerHTML = '<div class="error">No sales return found with reference: ' + searchTerm + '</div>';
                }
            } catch (error) {
                resultsSection.innerHTML = '<div class="error">Error: ' + error.message + '</div>';
            }
        });

        // Event listener for all report export buttons
        document.getElementById('exportAllBtn').addEventListener('click', function() {
            if (lastFilterResults.length > 0) {
                const today = new Date().toISOString().slice(0, 10);
                exportToCSV(lastFilterResults, `SR_DateStockist_Data_${today}`);
            } else {
                 alert("No data to export. Please run a report search first.");
            }
        });
        document.getElementById('exportProductBtn').addEventListener('click', function() {
             if (lastFilterResults.length > 0) {
                const today = new Date().toISOString().slice(0, 10);
                exportToCSV(lastFilterResults, `SR_ProductReport_Data_${today}`);
            } else {
                 alert("No data to export. Please run a report search first.");
            }
        });
        document.getElementById('exportExpiryBtn').addEventListener('click', function() {
             if (lastFilterResults.length > 0) {
                const today = new Date().toISOString().slice(0, 10);
                exportToCSV(lastFilterResults, `SR_ExpiryReport_Data_${today}`);
            } else {
                 alert("No data to export. Please run a report search first.");
            }
        });
        document.getElementById('exportChartBtn').addEventListener('click', function() {
             if (lastFilterResults.length > 0) {
                const today = new Date().toISOString().slice(0, 10);
                exportToCSV(lastFilterResults, `SR_ChartReport_RawData_${today}`);
            } else {
                 alert("No data to export. Please run a report search first.");
            }
        });

document.getElementById('printForm').addEventListener('submit', async e=>{
e.preventDefault();

const sheetId=document.getElementById('sheetId').value.trim();
const search=document.getElementById('printSearch').value.trim().toUpperCase();
const resultsSection=document.getElementById('resultsSection');

hideAllExportButtons();
destroyCharts();

if(!search){
resultsSection.innerHTML='<div class="error">Enter SR Ref No or Invoice No</div>';
return;
}

resultsSection.innerHTML='<div class="loading">Generating document...</div>';

const data=await fetchSheetData(sheetId);

// filter ONLY one SR / Invoice
const results=data.filter(row =>
(row['SR Ref No.'] && row['SR Ref No.'].toUpperCase()===search) ||
(row['C. INV NO.'] && row['C. INV NO.'].toUpperCase()===search)
);

if(!results.length){
resultsSection.innerHTML='<div class="no-results">No document found</div>';
return;
}

// show same professional layout as single SR search
resultsSection.innerHTML = generateInvoiceHTML(results);

// enable print button
document.getElementById('printPdfBtn').style.display='block';
});

        // Handle Date + Stockist Form (Grouped Card View)
        document.getElementById('dateStockistForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const sheetId = document.getElementById('sheetId').value.trim();
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const stockist = document.getElementById('stockistSelect').value.trim();
            const resultsSection = document.getElementById('resultsSection');
            
            hideAllExportButtons();
            destroyCharts();

            lastFilterResults = []; 
            window.groupedResults = {}; 

            if (!sheetId) {
                resultsSection.innerHTML = '<div class="error">Please enter Google Sheet ID.</div>';
                return;
            }
            
            // LOGIC: Check if BOTH dates are set
            const isDateRangeSet = fromDate && toDate;

            let from = null;
            let to = null;
            if (isDateRangeSet) {
                from = new Date(fromDate); 
                from.setHours(0, 0, 0, 0); 
                to = new Date(toDate);
                to.setHours(23, 59, 59, 999);
            }
            
            resultsSection.innerHTML = '<div class="loading">Searching by date & stockist...</div>';

            try {
                const data = await fetchSheetData(sheetId);
                
                const filtered = data.filter(row => {
                    // 1. Stockist Filter
                    if (stockist && row['STOCKIST NAME'] !== stockist) {
                        return false;
                    }
                    
                    // 2. Date Range Filter (Applied only if BOTH dates are set)
                    if (isDateRangeSet) {
                        const uploaded = parseDate(row['C. INV DATE']);
                        if (!uploaded || isNaN(uploaded.getTime())) return false; 
                        
                        if (uploaded.getTime() < from.getTime() || uploaded.getTime() > to.getTime()) return false;
                    }

                    return true;
                });

                if (filtered.length === 0) {
                    resultsSection.innerHTML = '<div class="no-results">No records found for given filter.</div>';
                    return;
                }
                
                lastFilterResults = filtered; 
                document.getElementById('exportAllBtn').style.display = 'block'; 

                // Group by SR Ref No (For the detailed card view)
                const grouped = {};
                filtered.forEach(row => {
                    const key = row['SR Ref No.'];
                    if (!grouped[key]) grouped[key] = [];
                    grouped[key].push(row);
                });


                let html = "";
                for (const [srRef, rows] of Object.entries(grouped)) {
                    const first = rows[0];
                    const totalGrandAmount = rows.reduce((sum, row) => sum + (parseFloat(row['TOTAL'].replace(/[^0-9.-]+/g,"")) || 0), 0).toFixed(2);
                    const expandedContent = generateResultCardHtml(rows, true); 
                    
                    html += `
                        <div class="result-card" id="card-${srRef}">
                            <div class="result-header" style="flex-wrap: wrap; justify-content: space-between; align-items: flex-start;">
                                <div style="flex-basis: 70%;">
                                    <div class="sr-ref" style="font-size: 1.2rem; font-weight: 700; color: #800000; line-height: 1.2;">
                                        ${first['STOCKIST NAME'] || 'N/A'}
                                    </div>
                                    <div style="font-size:0.9rem; font-weight: 500; color:#374151; margin-top: 2px;">
                                        SR: ${srRef} / C. Inv: ${first['C. INV NO.'] || '-'}
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px; flex-shrink: 0;">
                                    <div class="total-amount" style="margin-top: 2px;">Total: ‚Çπ${totalGrandAmount}</div>
                                    <button class="btn btn-secondary" style="margin-top: 0;" onclick="toggleExpand('${srRef}')">Expand</button>
                                </div>
                            </div>
                            <div id="details-${srRef}" style="display:none; padding-top: 15px;">
                                ${expandedContent}
                            </div>
                        </div>
                    `;
                }

                resultsSection.innerHTML = html;
                window.groupedResults = grouped;

            } catch (err) {
                resultsSection.innerHTML = '<div class="error">Error: ' + err.message + '</div>';
                document.getElementById('exportAllBtn').style.display = 'none';
            }
        });
document.getElementById('printPdfBtn').addEventListener('click',()=>{
const content=document.getElementById('resultsSection').innerHTML;

const win=window.open('','','width=900,height=700');
win.document.write(`
<html>
<head>
<title>Print Report</title>
<style>
body{font-family:Arial;padding:20px}
table{width:100%;border-collapse:collapse}
td,th{border:1px solid #000;padding:6px;font-size:12px}
</style>
</head>
<body>
${content}
</body>
</html>
`);

win.document.close();
win.print();
});

        // Handle Product Analysis Report
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const sheetId = document.getElementById('sheetId').value.trim();
            const product = document.getElementById('productSelect').value.trim();
            const batch = document.getElementById('batchInput').value.trim();
            const resultsSection = document.getElementById('resultsSection');
            
            hideAllExportButtons();
            destroyCharts();

            resultsSection.innerHTML = '<div class="loading">Generating Product Analysis Report...</div>';

            try {
                const data = await fetchSheetData(sheetId);
                
                const filtered = data.filter(row => 
                    row['PRODUCT'] === product && 
                    (!batch || row['BATCH'].toUpperCase() === batch.toUpperCase())
                );

                // Report Headers
                const headers = ['SR Ref No.', 'C. INV DATE', 'STOCKIST NAME', 'BATCH', 'EXPIRY', 'QTY', 'TOTAL'];
                displaySummaryTable(filtered, headers, `Product Return Report for ${product}`, 'exportProductBtn');

            } catch (err) {
                resultsSection.innerHTML = '<div class="error">Error: ' + err.message + '</div>';
            }
        });

        // Handle Expiry and Quality Report
        document.getElementById('expiryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const sheetId = document.getElementById('sheetId').value.trim();
            const expiryDate = document.getElementById('expiryBeforeDate').value;
            const remarks = document.getElementById('remarksKeyword').value.trim().toUpperCase();
            const stockist = document.getElementById('expiryStockistSelect').value.trim();
            const resultsSection = document.getElementById('resultsSection');

            hideAllExportButtons();
            destroyCharts();

            if (!expiryDate) {
                 // This check remains because this field is required in HTML for this report
                 resultsSection.innerHTML = '<div class="error">Expiry Date (Before) is required for this report.</div>';
                 return;
            }
            
            resultsSection.innerHTML = '<div class="loading">Generating Expiry/Quality Report...</div>';

            try {
                const data = await fetchSheetData(sheetId);
                
                const filterDate = new Date(expiryDate);
                filterDate.setHours(23, 59, 59, 999);
                
                const filtered = data.filter(row => {
                    // 1. Expiry Date Filter (Product expiry must be BEFORE the filter date)
                    const expiryValue = row['EXPIRY']; 
                    if (!expiryValue) return false;
                    
                    const parts = expiryValue.split('/');
                    if (parts.length < 2) return false;

                    const year = parseInt(parts[1], 10);
                    const month = parseInt(parts[0], 10);

                    // Assume 2-digit years are 20XX
                    const fullYear = (year < 100) ? 2000 + year : year;

                    if (isNaN(fullYear) || isNaN(month) || month < 1 || month > 12) return false;

                    // Create a date object for the last day of the expiry month
                    const productExpiry = new Date(fullYear, month, 0); 
                    
                    if (productExpiry.getTime() >= filterDate.getTime()) return false;
                    
                    // 2. Remarks Filter
                    if (remarks && row['REMARKS'].toUpperCase().indexOf(remarks) === -1) {
                        return false;
                    }
                    
                    // 3. Stockist Filter
                    if (stockist && row['STOCKIST NAME'] !== stockist) {
                        return false;
                    }

                    return true;
                });

                // Report Headers
                const headers = ['SR Ref No.', 'STOCKIST NAME', 'PRODUCT', 'BATCH', 'EXPIRY', 'QTY', 'REMARKS', 'TOTAL'];
                displaySummaryTable(filtered, headers, `Expiry/Quality Report`, 'exportExpiryBtn');

            } catch (err) {
                resultsSection.innerHTML = '<div class="error">Error: ' + err.message + '</div>';
            }
        });
        
        // Handle Product & Stockist Graphical Report (OLD)
        document.getElementById('chartReportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const sheetId = document.getElementById('sheetId').value.trim();
            const fromDate = document.getElementById('chartFromDate').value;
            const toDate = document.getElementById('chartToDate').value;
            const product = document.getElementById('chartProductSelect').value.trim();
            const stockist = document.getElementById('chartStockistSelect').value.trim();
            const resultsSection = document.getElementById('resultsSection');

            hideAllExportButtons();
            destroyCharts();

            if (!sheetId) {
                resultsSection.innerHTML = '<div class="error">Please enter Google Sheet ID.</div>';
                return;
            }

            resultsSection.innerHTML = '<div class="loading">Generating Graphical Report...</div>';

            try {
                const data = await fetchSheetData(sheetId);

                // LOGIC: Check if BOTH dates are set
                const isDateRangeSet = fromDate && toDate;

                let from = null;
                let to = null;
                if (isDateRangeSet) {
                    from = new Date(fromDate); 
                    from.setHours(0, 0, 0, 0); 
                    to = new Date(toDate);
                    to.setHours(23, 59, 59, 999);
                }

                const filtered = data.filter(row => {
                    // 1. Product Filter
                    if (product && row['PRODUCT'] !== product) {
                        return false;
                    }
                    
                    // 2. Stockist Filter
                    if (stockist && row['STOCKIST NAME'] !== stockist) {
                        return false;
                    }

                    // 3. Date Range Filter (Applied only if BOTH dates are set)
                    if (isDateRangeSet) {
                        const uploaded = parseDate(row['C. INV DATE']);
                        if (!uploaded || isNaN(uploaded.getTime())) return false; 
                        
                        if (uploaded.getTime() < from.getTime() || uploaded.getTime() > to.getTime()) return false;
                    }

                    return true;
                });

                if (filtered.length === 0) {
                    resultsSection.innerHTML = '<div class="no-results">No records found for the given criteria.</div>';
                    return;
                }
                
                lastFilterResults = filtered;
                document.getElementById('exportChartBtn').style.display = 'block';

                generateChartReport(filtered, product, stockist);

            } catch (err) {
                resultsSection.innerHTML = '<div class="error">Error: ' + err.message + '</div>';
            }
        });

        // Chart generation function (OLD)
        function generateChartReport(data, filterProduct, filterStockist) {
            const resultsSection = document.getElementById('resultsSection');

            // 1. Aggregate data for Bar Chart (Quantity by Product)
            const productQtyMap = data.reduce((acc, row) => {
                const key = row['PRODUCT'];
                const qty = parseInt(row['QTY'], 10) || 0;
                acc[key] = (acc[key] || 0) + qty;
                return acc;
            }, {});

            const productLabels = Object.keys(productQtyMap);
            const productQuantities = Object.values(productQtyMap);
            
            // 2. Aggregate data for Pie Chart (Total Value by Stockist)
            const stockistValueMap = data.reduce((acc, row) => {
                const key = row['STOCKIST NAME'];
                const total = parseFloat(row['TOTAL'].replace(/[^0-9.-]+/g,"")) || 0;
                acc[key] = (acc[key] || 0) + total;
                return acc;
            }, {});

            const stockistLabels = Object.keys(stockistValueMap);
            const stockistValues = Object.values(stockistValueMap);

            // Determine Chart Titles
            const barTitle = `Return Quantity by Product ${filterStockist ? `(Stockist: ${filterStockist})` : '(All Stockists)'}`;
            const pieTitle = `Return Value Distribution by Stockist ${filterProduct ? `(Product: ${filterProduct})` : '(All Products)'}`;


            // Prepare HTML for charts
            resultsSection.innerHTML = `
                <div class="chart-container">
                    <div class="chart-box">
                        <h3>${barTitle}</h3>
                        <canvas id="barChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3>${pieTitle}</h3>
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            `;
            
            // Generate Bar Chart (Quantity)
            const barCtx = document.getElementById('barChart').getContext('2d');
            barChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: productLabels,
                    datasets: [{
                        label: 'Returned Quantity',
                        data: productQuantities,
                        // CHANGED: From Dark Red to Dark Indigo
                        backgroundColor: '#800000',
                        borderColor: '#800000',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantity'
                            }
                        }
                    }
                }
            });

            // Generate Pie Chart (Value)
            const pieCtx = document.getElementById('pieChart').getContext('2d');
             // Generate a dynamic set of colors
            const dynamicColors = stockistLabels.map((_, i) => `hsl(${i * 30 + 240}, 70%, 50%)`); // Offset HSL to start around blue/indigo

            pieChartInstance = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: stockistLabels,
                    datasets: [{
                        label: 'Return Value (‚Çπ)',
                        data: stockistValues,
                        backgroundColor: dynamicColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });

        }


        // NEW AI ANALYSIS REPORT (JS IMPLEMENTATION)
        
        // Handle AI Analysis Report (NEW)
        document.getElementById('aiAnalysisForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const sheetId = document.getElementById('sheetId').value.trim();
            const fromDate = document.getElementById('aiFromDate').value;
            const toDate = document.getElementById('aiToDate').value;
            const resultsSection = document.getElementById('resultsSection');

            hideAllExportButtons();
            destroyCharts();

            if (!sheetId) {
                resultsSection.innerHTML = '<div class="error">Please enter Google Sheet ID.</div>';
                return;
            }

            resultsSection.innerHTML = '<div class="loading">Generating AI Analysis Report...</div>';

            try {
                const data = await fetchSheetData(sheetId);

                const isDateRangeSet = fromDate && toDate;
                let from = null;
                let to = null;
                if (isDateRangeSet) {
                    from = new Date(fromDate); 
                    from.setHours(0, 0, 0, 0); 
                    to = new Date(toDate);
                    to.setHours(23, 59, 59, 999);
                }

                const filtered = data.filter(row => {
                    // Apply Date Range Filter (Applied only if BOTH dates are set)
                    if (isDateRangeSet) {
                        const invDate = parseDate(row['C. INV DATE']);
                        if (!invDate || isNaN(invDate.getTime())) return false; 
                        
                        if (invDate.getTime() < from.getTime() || invDate.getTime() > to.getTime()) return false;
                    }
                    return true;
                });

                if (filtered.length === 0) {
                    resultsSection.innerHTML = '<div class="no-results">No records found for the given time period.</div>';
                    return;
                }
                
                generateAIAnalysis(filtered, fromDate, toDate);

            } catch (err) {
                resultsSection.innerHTML = '<div class="error">Error: ' + err.message + '</div>';
            }
        });


        // Function to generate the AI Analysis dashboard
        function generateAIAnalysis(data, fromDate, toDate) {
            const resultsSection = document.getElementById('resultsSection');
            
            // --- 1. KPI Calculation ---
            const totalReturnsValue = data.reduce((sum, row) => sum + (parseFloat(row['TOTAL'].replace(/[^0-9.-]+/g,"")) || 0), 0);
            const totalProductsReturned = data.reduce((sum, row) => sum + (parseInt(row['QTY'], 10) || 0), 0);
            const totalUniqueSR = new Set(data.map(row => row['SR Ref No.'])).size;

            // --- 2. Top Returned Products (by Value) ---
            const productValueMap = data.reduce((acc, row) => {
                const key = row['PRODUCT'];
                const total = parseFloat(row['TOTAL'].replace(/[^0-9.-]+/g,"")) || 0;
                acc[key] = (acc[key] || 0) + total;
                return acc;
            }, {});
            const topProducts = Object.entries(productValueMap)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);

            // --- 3. Top Stockists (by Value) ---
            const stockistValueMap = data.reduce((acc, row) => {
                const key = row['STOCKIST NAME'];
                const total = parseFloat(row['TOTAL'].replace(/[^0-9.-]+/g,"")) || 0;
                acc[key] = (acc[key] || 0) + total;
                return acc;
            }, {});
            const topStockists = Object.entries(stockistValueMap)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);

            // --- 4. Remarks Analysis (Root Cause) ---
            const remarksMap = data.reduce((acc, row) => {
                const remark = (row['REMARKS'] || 'OTHER').toUpperCase().trim();
                let key = 'OTHER';
                if (remark.includes('DAMAGE')) key = 'DAMAGED';
                else if (remark.includes('EXPIRED')) key = 'EXPIRED';
                else if (remark.includes('QC')) key = 'QUALITY ISSUE';
                
                acc[key] = (acc[key] || 0) + (parseFloat(row['TOTAL'].replace(/[^0-9.-]+/g,"")) || 0);
                return acc;
            }, {});
            const topReasons = Object.entries(remarksMap)
                .sort(([, a], [, b]) => b - a);

            // --- 5. Render HTML Dashboard ---
            let dateRangeText = "All Time";
            if (fromDate && toDate) {
                dateRangeText = `${new Date(fromDate).toLocaleDateString()} - ${new Date(toDate).toLocaleDateString()}`;
            }

            let dashboardHtml = `
                <h2 style="font-size: 1.5rem; color: #800000; padding: 10px 0; border-bottom: 2px solid #dc2626; margin-bottom: 20px;">
                    AI & Trend Analysis (${dateRangeText})
                </h2>
                
                <div class="chart-container" style="justify-content: space-between;">
                    
                    <div class="chart-box" style="flex-grow: 0; min-width: 100%;">
                        <h3>Return Key Performance Indicators (KPIs)</h3>
                        <div class="section-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div class="field" style="background: #fef2f2; border-color: #dc2626;">
                                <div class="field-label" style="color: #800000;">Total Return Value</div>
                                <div class="field-value" style="font-size: 1.8rem; font-weight: 700; color: #800000;">‚Çπ${totalReturnsValue.toFixed(2)}</div>
                            </div>
                            <div class="field" style="background: #fff7ed; border-color: #f59e0b;">
                                <div class="field-label" style="color: #f59e0b;">Total Products Qty Returned</div>
                                <div class="field-value" style="font-size: 1.8rem; font-weight: 700; color: #b45309;">${totalProductsReturned.toLocaleString()}</div>
                            </div>
                            <div class="field" style="background: #f0fdf4; border-color: #10b981;">
                                <div class="field-label" style="color: #047857;">Unique SR Documents</div>
                                <div class="field-value" style="font-size: 1.8rem; font-weight: 700; color: #047857;">${totalUniqueSR.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-box" style="min-width: 300px;">
                        <h3>Top 5 Returned Products (Value)</h3>
                        <ol style="padding-left: 20px; font-size: 0.9rem;">
                            ${topProducts.map(([product, value]) => 
                                `<li>${product}: <strong>‚Çπ${value.toFixed(2)}</strong></li>`
                            ).join('')}
                        </ol>
                    </div>
                    
                    <div class="chart-box" style="min-width: 300px;">
                        <h3>Top 5 Stockists by Return Value</h3>
                        <ol style="padding-left: 20px; font-size: 0.9rem;">
                            ${topStockists.map(([stockist, value]) => 
                                `<li>${stockist}: <strong>‚Çπ${value.toFixed(2)}</strong></li>`
                            ).join('')}
                        </ol>
                    </div>
                    
                    <div class="chart-box" style="min-width: 300px;">
                        <h3>Return Reason Breakdown (Value)</h3>
                        <ol style="padding-left: 20px; font-size: 0.9rem;">
                            ${topReasons.map(([reason, value]) => 
                                `<li>${reason}: <strong>‚Çπ${value.toFixed(2)}</strong> (${(value/totalReturnsValue * 100).toFixed(1)}%)</strong></li>`
                            ).join('')}
                        </ol>
                    </div>

                </div>
                
                <div class="chart-container" style="height: 350px; padding: 0 20px 20px 20px;">
                    <div class="chart-box" style="max-width: 100%; min-width: 100%; height: 100%;">
                        <h3>Monthly Return Trend (by C. Inv Date Value)</h3>
                        <canvas id="monthlyTrendChart"></canvas>
                    </div>
                </div>
            `;

            resultsSection.innerHTML = dashboardHtml;

            // --- 6. Generate Monthly Trend Chart ---
            
            // Get the selected chart type (MODIFIED)
            const chartType = document.querySelector('input[name="trendChartType"]:checked').value;
            
            // Group and aggregate data by month (C. INV DATE)
            const monthlyDataMap = data.reduce((acc, row) => {
                const invDate = parseDate(row['C. INV DATE']);
                if (invDate) {
                    // Use YYYY-MM for sorting and grouping
                    const monthKey = `${invDate.getFullYear()}-${String(invDate.getMonth() + 1).padStart(2, '0')}`;
                    const total = parseFloat(row['TOTAL'].replace(/[^0-9.-]+/g,"")) || 0;
                    acc[monthKey] = (acc[monthKey] || 0) + total;
                }
                return acc;
            }, {});
            
            // Convert to array and sort by month key
            const sortedMonthlyData = Object.entries(monthlyDataMap).sort(([a], [b]) => a.localeCompare(b));
            
            const monthlyLabels = sortedMonthlyData.map(([key]) => {
                const [year, month] = key.split('-');
                return new Date(year, month - 1).toLocaleString('en-US', { month: 'short', year: '2-digit' });
            });
            const monthlyValues = sortedMonthlyData.map(([, value]) => value);

            // Create the Chart
            const trendCtx = document.getElementById('monthlyTrendChart').getContext('2d');
            
            // Destroy existing instance before creating a new one (important for dynamic type change)
            if (barChartInstance) { barChartInstance.destroy(); }

            // Configure bar width only if it's a bar chart (NEW OPTION)
            const barOptions = chartType === 'bar' ? {
                // These options reduce the bar width
                categoryPercentage: 0.6, 
                barPercentage: 0.8,
            } : {};
            
            barChartInstance = new Chart(trendCtx, { 
                type: chartType, // Use dynamic type (MODIFIED)
                data: {
                    labels: monthlyLabels,
                    datasets: [{
                        label: 'Return Value (‚Çπ)',
                        data: monthlyValues,
                        // Dynamic styling based on type (MODIFIED) - Changed from Red to Indigo
                        backgroundColor: chartType === 'bar' ? '#dc2626' : 'rgba(79, 70, 229, 0.5)', 
                        borderColor: '#800000', 
                        borderWidth: chartType === 'line' ? 3 : 1, 
                        fill: chartType === 'line' ? false : true,
                        tension: chartType === 'line' ? 0.4 : 0, 
                        pointRadius: chartType === 'line' ? 5 : 0 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Return Value (‚Çπ)'
                            }
                        },
                         x: { // Apply bar options to x-axis
                             ...barOptions,
                             grid: {
                                 // Add grid setting here for bar display
                                 drawOnChartArea: true 
                             }
                         } 
                    }
                }
            });

        }
        // END AI ANALYSIS REPORT (JS IMPLEMENTATION)


        // Populate all dropdowns (Stockists and Products)
        async function populateStockistsAndProducts(sheetId) {
            try {
                const data = await fetchSheetData(sheetId);
                const stockistSet = new Set();
                const productSet = new Set();
                
                data.forEach(row => {
                    if (row['STOCKIST NAME']) stockistSet.add(row['STOCKIST NAME']);
                    if (row['PRODUCT']) productSet.add(row['PRODUCT']);
                });

                const sortedStockists = Array.from(stockistSet).sort();
                const sortedProducts = Array.from(productSet).sort();

                // Populate Stockist Dropdowns
                const stockistSelects = [
                    document.getElementById('stockistSelect'), 
                    document.getElementById('expiryStockistSelect'),
                    document.getElementById('chartStockistSelect'), // Graphical Report
document.getElementById('printStockist')
                ];
                
                stockistSelects.forEach(select => {
                    select.innerHTML = '<option value="">All Stockists</option>'; 
                    sortedStockists.forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        select.appendChild(opt);
                    });
                });

                // Populate Product Dropdown
                const productSelects = [
                    document.getElementById('productSelect'),
                    document.getElementById('chartProductSelect') // Graphical Report
                ];
                
                productSelects.forEach(select => {
                    select.innerHTML = select.id === 'productSelect' ? '<option value="">Select Product</option>' : '<option value="">All Products</option>';
                    sortedProducts.forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        select.appendChild(opt);
                    });
                });

            } catch (err) {
                console.error("Failed to populate dropdowns", err);
            }
        }


        // Toggle expand/collapse function
        function toggleExpand(srRef) {
            const div = document.getElementById('details-' + srRef);
            const button = document.getElementById('card-' + srRef).querySelector('.result-header button');
            
            if (div.style.display === 'none') {
                div.style.display = 'block';
                button.textContent = 'Collapse';
                // Find the first occurrence of the stockist name and change its color to dark indigo
                const srRefDiv = document.getElementById('card-' + srRef).querySelector('.sr-ref');
                 if (srRefDiv) {
                     srRefDiv.style.color = '#1f2937'; // Change to standard dark text when expanded
                 }
            } else {
                div.style.display = 'none';
                button.textContent = 'Expand';
                // Change the stockist name color back to dark indigo when collapsed
                const srRefDiv = document.getElementById('card-' + srRef).querySelector('.sr-ref');
                 if (srRefDiv) {
                     srRefDiv.style.color = '#800000'; // Dark Indigo
                 }
            }
        }


        // Trigger dropdown population and set default tab on page load
        document.addEventListener('DOMContentLoaded', () => {
            const sheetId = document.getElementById('sheetId').value.trim();
            if (sheetId) {	
                setTimeout(() => populateStockistsAndProducts(sheetId), 500);
            }
             // Ensure the default tab content is displayed
            document.getElementById('srSearch').style.display = 'block';
            document.getElementById('srSearch').classList.add('active');
            
            // Set default chart type for AI Analysis (NEW)
            const defaultChartType = document.getElementById('chartTypeBar');
            if (defaultChartType) {
                 defaultChartType.checked = true;
            }
        });
function downloadSR(sr){
const rows = window.groupedResults?.[sr] || lastSearchResults;
if(!rows) return alert("Data not found");

const win = window.open('','','width=900,height=700');
win.document.write(generateInvoiceHTML(rows));
win.document.close();
win.print();
}
    </script>
</body>
</html>
